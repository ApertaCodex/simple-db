<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>SQLite Browser & Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/sql-wasm.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#09090b',
                            surface: '#18181b',
                            border: '#27272a',
                            text: '#fafafa',
                            muted: '#a1a1aa'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-main: #ffffff;
            --bg-surface: #ffffff;
            --border-color: #e5e7eb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --scrollbar-track: #f1f1f1;
            --scrollbar-thumb: #c1c1c1;
            --scrollbar-thumb-hover: #a8a8a8;
        }

        .dark {
            --bg-main: #09090b;
            --bg-surface: #18181b;
            --border-color: #27272a;
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --scrollbar-track: #18181b;
            --scrollbar-thumb: #3f3f46;
            --scrollbar-thumb-hover: #71717a;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        .fade-in {
            animation: fadeIn 0.15s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        th.dragging {
            opacity: 0.4;
            background-color: #e5e7eb;
            border: 2px dashed #9ca3af;
        }

        th.drag-over-left {
            border-left: 3px solid #2563eb;
        }

        th.drag-over-right {
            border-right: 3px solid #2563eb;
        }

        .sort-badge {
            font-size: 0.65rem;
            height: 16px;
            width: 16px;
            line-height: 16px;
            text-align: center;
            border-radius: 50%;
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 700;
            display: inline-block;
            margin-left: 2px;
        }

        /* Loading Overlay */
        #loadingOverlay {
            background: rgba(var(--bg-surface-rgb, 255, 255, 255), 0.8);
            backdrop-filter: blur(2px);
        }

        .dark #loadingOverlay {
            background: rgba(0, 0, 0, 0.85);
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(37, 99, 235, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        .pulse-animation {
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>

<body
    class="bg-white text-gray-800 h-screen flex flex-col overflow-hidden transition-colors duration-300 dark:bg-zinc-900 dark:text-zinc-100 m-0 p-0">

    <div id="loadingOverlay" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <span class="material-symbols-outlined text-4xl animate-spin text-blue-600 mb-2">progress_activity</span>
            <span class="text-sm font-medium text-gray-600" id="loadingText">Processing...</span>
        </div>
    </div>

    <header
        class="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between shadow-sm z-20 dark:bg-zinc-900 dark:border-zinc-800 dark:shadow-none transition-colors">
        <div class="flex items-center gap-4">
            <!-- Upload Button -->
            <div class="group relative">
                <div class="bg-blue-600 text-white p-2 rounded-lg cursor-pointer hover:bg-blue-700 transition-colors shadow-md hover:shadow-lg active:scale-95 duration-200"
                    onclick="document.getElementById('dbFileInput').click()">
                    <span class="material-symbols-outlined text-xl block">upload_file</span>
                </div>
                <input type="file" id="dbFileInput" class="hidden" accept=".db,.sqlite,.sqlite3" multiple
                    onchange="handleFileUpload(event)">
            </div>

            <!-- DB Info -->
            <div class="flex flex-col" id="dbInfoContainer">
                <h1 class="text-lg font-semibold text-gray-800 leading-tight dark:text-zinc-100 flex items-center gap-2"
                    id="dbName">
                    No Database
                </h1>
                <p class="text-xs text-gray-500 dark:text-zinc-500" id="dbMeta">Load a .sqlite file to begin</p>
            </div>

            <!-- Database Selector (for webview mode with multiple databases) -->
            <div class="hidden flex items-center gap-3" id="databaseSelectorContainer">
                <label for="databaseSelect" class="text-sm font-medium text-gray-500 dark:text-zinc-400">Database:</label>
                <div class="relative group">
                    <select id="databaseSelect" onchange="switchSelectedDatabase(this.value)"
                        class="appearance-none bg-white border border-gray-300 text-gray-900 text-sm font-medium font-mono rounded-lg pl-3 pr-10 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-gray-50 hover:border-gray-400 transition-all cursor-pointer shadow-sm min-w-[150px] dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-100 dark:hover:bg-zinc-800 dark:hover:border-zinc-600 dark:focus:ring-blue-600">
                    </select>
                    <div
                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500 dark:text-zinc-500 group-hover:text-gray-700 dark:group-hover:text-zinc-300">
                        <span class="material-symbols-outlined text-lg">expand_more</span>
                    </div>
                </div>
            </div>

            <!-- Table Selector -->
            <div class="hidden h-8 w-px bg-gray-200 mx-2 dark:bg-zinc-800 md:block"></div>
            <div class="hidden flex items-center gap-3" id="tableSelectorContainer">
                <label for="tableSelect" class="text-sm font-medium text-gray-500 dark:text-zinc-400">Table:</label>
                <div class="relative group">
                    <select id="tableSelect" onchange="loadTable(this.value)"
                        class="appearance-none bg-white border border-gray-300 text-gray-900 text-sm font-medium font-mono rounded-lg pl-3 pr-10 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:bg-gray-50 hover:border-gray-400 transition-all cursor-pointer shadow-sm min-w-[150px] dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-100 dark:hover:bg-zinc-800 dark:hover:border-zinc-600 dark:focus:ring-blue-600">
                    </select>
                    <div
                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500 dark:text-zinc-500 group-hover:text-gray-700 dark:group-hover:text-zinc-300">
                        <span class="material-symbols-outlined text-lg">expand_more</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Actions -->
        <div class="flex items-center gap-3">
            <!-- Search -->
            <div class="relative hidden md:block group">
                <span
                    class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-lg dark:text-zinc-500 group-focus-within:text-blue-500 transition-colors">search</span>
                <input
                    class="pl-10 pr-4 py-1.5 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:bg-white focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 w-48 focus:w-64 transition-all dark:bg-zinc-950 dark:border-zinc-700 dark:text-zinc-200 dark:placeholder-zinc-600 dark:focus:bg-zinc-900 dark:focus:border-blue-500 dark:focus:ring-blue-500/20"
                    id="globalSearch" placeholder="Search data..." type="text">
            </div>

            <div class="h-6 w-px bg-gray-200 mx-1 dark:bg-zinc-800"></div>

            <!-- Toolbar Buttons -->
            <button
                class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-800 dark:hover:text-zinc-100"
                onclick="toggleQueryPanel()" title="SQL Query Editor">
                <span class="material-symbols-outlined text-lg">terminal</span> <span
                    class="hidden sm:inline">Query</span>
            </button>
            <button
                class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all dark:bg-zinc-900 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-800 dark:hover:text-zinc-100"
                onclick="exportData()" title="Export CSV">
                <span class="material-symbols-outlined text-lg">download</span>
            </button>

            <!-- Theme Toggle -->
            <button
                class="flex items-center justify-center p-1.5 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700 dark:hover:text-white"
                onclick="toggleTheme()" id="themeToggle" title="Toggle Theme">
                <span class="material-symbols-outlined text-xl" id="themeIcon">dark_mode</span>
            </button>
        </div>
    </header>


    <div class="hidden bg-white border-b border-gray-200 shadow-inner flex-shrink-0 transition-all duration-300 ease-in-out dark:bg-zinc-900 dark:border-zinc-800"
        id="queryPanel">
        <div class="p-4 max-w-7xl mx-auto">
            <div class="flex gap-4 mb-3">
                <div class="flex bg-gray-100 p-1 rounded-lg dark:bg-zinc-800">
                    <button
                        class="px-4 py-1.5 text-sm font-medium rounded-md shadow-sm bg-white text-gray-900 transition-all dark:bg-zinc-700 dark:text-zinc-100"
                        id="modeSql" onclick="setQueryMode('sql')">SQL</button>
                    <button
                        class="px-4 py-1.5 text-sm font-medium rounded-md text-gray-500 hover:text-gray-900 transition-all flex items-center gap-1 dark:text-zinc-400 dark:hover:text-zinc-100"
                        id="modeAi" onclick="setQueryMode('ai')">
                        AI
                    </button>
                </div>
                <div class="flex-1" id="sampleQueriesContainer">
                    <select
                        class="w-full text-sm border-gray-300 border rounded-md px-3 py-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200"
                        id="sampleQueries" onchange="loadSampleQuery(this.value)">
                        <option value="">-- Sample Queries --</option>
                    </select>
                </div>
            </div>
            <div class="relative">
                <textarea
                    class="w-full font-mono text-sm bg-gray-50 border border-gray-300 rounded-lg p-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all resize-y dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200 dark:placeholder-zinc-500"
                    id="queryInput" placeholder="SELECT * FROM..." rows="4"></textarea>
                <div class="absolute bottom-3 right-3 flex gap-2">
                    <button
                        class="px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50 dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-300 dark:hover:bg-zinc-600"
                        onclick="clearQuery()">Clear</button>
                    <button id="runQueryBtn"
                        class="px-4 py-1.5 text-xs font-bold text-white bg-blue-600 rounded hover:bg-blue-700 shadow-sm flex items-center gap-1 dark:bg-blue-700 dark:hover:bg-blue-600"
                        onclick="executeCustomQuery()">
                        <span class="material-symbols-outlined text-sm">play_arrow</span> Run
                    </button>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500 hidden dark:text-zinc-400" id="queryStatus"></div>
        </div>
    </div>

    <div
        class="px-6 py-3 bg-white border-b border-gray-200 flex items-center justify-between flex-shrink-0 dark:bg-zinc-900 dark:border-zinc-800">
        <div class="flex items-center gap-2">
            <span
                class="text-sm font-medium text-gray-600 bg-gray-100 px-2 py-1 rounded dark:bg-zinc-800 dark:text-zinc-300"
                id="totalRecords">0
                Records</span>
            <span
                class="hidden text-xs font-medium text-blue-700 bg-blue-50 px-2 py-1 rounded border border-blue-100 flex items-center gap-1 cursor-pointer hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800"
                id="filterBadge" onclick="clearAllFilters()">
                Filters Active <span class="material-symbols-outlined text-xs">close</span>
            </span>
            <span class="text-xs text-gray-400 ml-2 italic hidden md:inline dark:text-zinc-500">Shift+Click to
                multi-sort. Drag headers to
                reorder.</span>
        </div>
        <div class="flex items-center gap-2">
            <button
                class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50 hover:text-blue-600 transition-colors dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-700 dark:hover:text-blue-400"
                onclick="toggleColumnManager(event)">
                <span class="material-symbols-outlined text-lg">view_column</span> Columns
            </button>
            <button
                class="flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded hover:bg-gray-50 hover:text-red-600 transition-colors dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-300 dark:hover:bg-zinc-700 dark:hover:text-red-400"
                onclick="resetView()">
                <span class="material-symbols-outlined text-lg">restart_alt</span> Reset
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-auto relative custom-scrollbar bg-white dark:bg-zinc-900">
        <table class="w-full text-left border-collapse">
            <thead
                class="bg-gray-50 sticky top-0 z-10 shadow-sm text-xs uppercase text-gray-500 font-semibold tracking-wider dark:bg-zinc-800 dark:text-zinc-300 dark:shadow-black/50">
                <tr id="tableHeaderRow">
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 text-sm text-gray-700 dark:divide-zinc-700 dark:text-zinc-200"
                id="tableBody">
            </tbody>
            </tbody>
        </table>

        <div class="flex flex-col items-center justify-center h-64 text-gray-400 dark:text-zinc-500" id="emptyState">
            <span class="material-symbols-outlined text-6xl mb-2">upload_file</span>
            <p class="text-lg font-medium text-gray-500 dark:text-zinc-400">No database loaded</p>
            <p class="text-sm text-gray-400 mb-4 dark:text-zinc-500">Upload a .db or .sqlite file to begin</p>
            <button
                class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-600"
                onclick="document.getElementById('dbFileInput').click()">Select File</button>
        </div>
    </div>

    <footer
        class="bg-white border-t border-gray-200 px-6 py-3 flex items-center justify-between flex-shrink-0 text-sm dark:bg-zinc-900 dark:border-zinc-800">
        <div class="flex items-center gap-2 text-gray-600 dark:text-zinc-400">
            <span>Rows:</span>
            <select
                class="border-gray-300 border rounded py-1 px-2 focus:ring-blue-500 focus:border-blue-500 bg-transparent cursor-pointer dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-300"
                id="rowsPerPage" onchange="changeRowsPerPage(this.value)">
                <option value="10">10</option>
                <option selected="" value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-gray-600 dark:text-zinc-400" id="pageInfo">Page 1 of 1</span>
            <div class="flex gap-1">
                <button
                    class="p-1 rounded hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed text-gray-600 dark:text-zinc-400 dark:hover:bg-zinc-800"
                    id="btnPrev" onclick="prevPage()" disabled="">
                    <span class="material-symbols-outlined">chevron_left</span>
                </button>
                <button
                    class="p-1 rounded hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed text-gray-600 dark:text-zinc-400 dark:hover:bg-zinc-800"
                    id="btnNext" onclick="nextPage()" disabled="">
                    <span class="material-symbols-outlined">chevron_right</span>
                </button>
            </div>
        </div>
    </footer>

    <div class="hidden absolute z-50 bg-white border border-gray-200 rounded-lg shadow-xl w-64 text-sm fade-in dark:bg-zinc-900 dark:border-zinc-800 dark:shadow-zinc-950"
        id="columnManager" style="top: 130px; right: 24px;">
        <div
            class="p-3 border-b border-gray-200 bg-gray-50 rounded-t-lg flex justify-between items-center dark:bg-zinc-800 dark:border-zinc-700">
            <span class="font-semibold text-gray-700 dark:text-zinc-200">Manage Columns</span>
            <button class="text-gray-400 hover:text-gray-700 dark:hover:text-zinc-200"
                onclick="document.getElementById('columnManager').classList.add('hidden')"><span
                    class="material-symbols-outlined text-lg">close</span></button>
        </div>
        <div class="p-2 max-h-64 overflow-y-auto custom-scrollbar" id="columnList"></div>
    </div>

    <div class="hidden absolute z-50 bg-white border border-gray-200 rounded-lg shadow-xl w-80 text-sm fade-in dark:bg-zinc-900 dark:border-zinc-800 dark:shadow-zinc-950"
        id="filterPopover">
        <div
            class="p-3 border-b border-gray-200 bg-gray-50 rounded-t-lg flex justify-between items-center dark:bg-zinc-800 dark:border-zinc-700">
            <span class="font-semibold text-gray-700 dark:text-zinc-200" id="filterTitle">Filter Column</span>
            <button class="text-gray-400 hover:text-gray-700 dark:hover:text-zinc-200"
                onclick="closeFilterPopover()"><span class="material-symbols-outlined text-lg">close</span></button>
        </div>
        <div class="p-4 space-y-3" id="filterContent"></div>
        <div
            class="p-3 border-t border-gray-200 bg-gray-50 rounded-b-lg flex justify-end gap-2 dark:bg-zinc-800 dark:border-zinc-700">
            <button
                class="px-3 py-1.5 text-gray-600 hover:bg-gray-200 rounded border border-gray-300 bg-white dark:bg-zinc-700 dark:text-zinc-300 dark:border-zinc-600 dark:hover:bg-zinc-600"
                onclick="clearCurrentFilter()">Clear</button>
            <button
                class="px-3 py-1.5 text-white bg-blue-600 hover:bg-blue-700 rounded shadow-sm dark:bg-blue-700 dark:hover:bg-blue-600"
                onclick="applyCurrentFilter()">Apply</button>
        </div>
    </div>

    <script>
        // --- VS Code Webview Integration ---
        const vscode = window.acquireVsCodeApi ? acquireVsCodeApi() : null;
        const isVSCodeWebview = window.isVSCodeWebview || false;

        // --- 1. Global State & DB Variables ---
        let db = null;
        let SQL = null;
        let allData = [];
        let filteredData = [];
        let columns = [];
        let visibleColumns = [];
        let columnStats = {};
        let sortConfig = [];
        let draggedColumn = null;
        let tables = [];
        let currentDbFile = null;
        let suggestedQueries = [];
        let tableSettings = {}; // { tableName: { visibleColumns, filters, sort, ... } }

        // Multi-DB State
        let databases = {}; // { name: { data: u8arr, size: int } }
        let currentDbName = null;
        let currentTableName = null;

        // Available databases from VS Code extension
        let availableDatabases = window.availableDatabases || [];

        let state = {
            currentPage: 1,
            rowsPerPage: 20,
            columnFilters: {},
            globalSearch: '',
            darkMode: false
        };

        // --- 2. Theme Management ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                setTheme(true);
            } else {
                setTheme(false);
            }
        }

        function toggleTheme() {
            setTheme(!state.darkMode);
        }

        function setTheme(isDark) {
            state.darkMode = isDark;
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');

            if (isDark) {
                html.classList.add('dark');
                if (themeIcon) themeIcon.textContent = 'light_mode';
                localStorage.setItem('theme', 'dark');
            } else {
                html.classList.remove('dark');
                if (themeIcon) themeIcon.textContent = 'dark_mode';
                localStorage.setItem('theme', 'light');
            }
        }

        // --- 3. Caching & Persistence (IndexedDB) ---
        const CACHE_KEYS = {
            DB_FILE: 'simpledb_cached_file',
            TABLES: 'simpledb_cached_tables',
            CURRENT_TABLE: 'simpledb_current_table',
            TABLE_SETTINGS: 'simpledb_table_settings',
            PAGE_STATE: 'simpledb_page_state',
            GLOBAL_SEARCH: 'simpledb_global_search',
            AI_SAMPLE_QUERIES: 'simpledb_ai_sample_queries'
        };

        const IDB_CONFIG = {
            DB_NAME: 'SimpleDB_Storage',
            STORE_NAME: 'files',
            VERSION: 1,
            KEY: 'current_db_file'
        };

        function openIDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(IDB_CONFIG.DB_NAME, IDB_CONFIG.VERSION);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(IDB_CONFIG.STORE_NAME)) {
                        db.createObjectStore(IDB_CONFIG.STORE_NAME);
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        async function saveFileToIDB(fileData) {
            try {
                const db = await openIDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(IDB_CONFIG.STORE_NAME, 'readwrite');
                    const store = tx.objectStore(IDB_CONFIG.STORE_NAME);
                    store.put(fileData, IDB_CONFIG.KEY);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            } catch (e) { console.error("IDB Save Error:", e); }
        }

        async function getFileFromIDB() {
            try {
                const db = await openIDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(IDB_CONFIG.STORE_NAME, 'readonly');
                    const store = tx.objectStore(IDB_CONFIG.STORE_NAME);
                    const req = store.get(IDB_CONFIG.KEY);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            } catch (e) { return null; }
        }

        async function clearIDB() {
            try {
                const db = await openIDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(IDB_CONFIG.STORE_NAME, 'readwrite');
                    const store = tx.objectStore(IDB_CONFIG.STORE_NAME);
                    store.delete(IDB_CONFIG.KEY);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            } catch (e) { console.error(e); }
        }

        function saveToCache() {
            try {
                const currentTable = document.getElementById('tableSelect')?.value;
                if (currentTable) {
                    tableSettings[currentTable] = {
                        visibleColumns: visibleColumns,
                        columnStats: columnStats,
                        filters: state.columnFilters,
                        sortConfig: sortConfig
                    };
                }

                const cacheData = {
                    [CACHE_KEYS.DB_FILE]: currentDbFile,
                    [CACHE_KEYS.TABLES]: tables,
                    [CACHE_KEYS.CURRENT_TABLE]: currentTable || '',
                    [CACHE_KEYS.TABLE_SETTINGS]: tableSettings,
                    [CACHE_KEYS.PAGE_STATE]: { currentPage: state.currentPage, rowsPerPage: state.rowsPerPage },
                    [CACHE_KEYS.GLOBAL_SEARCH]: state.globalSearch,
                    [CACHE_KEYS.AI_SAMPLE_QUERIES]: suggestedQueries
                };

                Object.entries(cacheData).forEach(([key, value]) => {
                    if (value !== null && value !== undefined) localStorage.setItem(key, JSON.stringify(value));
                });
            } catch (error) { console.warn('Failed to save to cache:', error); }
        }

        function loadFromCache() {
            try {
                const cachedFile = localStorage.getItem(CACHE_KEYS.DB_FILE);
                if (cachedFile) currentDbFile = JSON.parse(cachedFile);

                const cachedTables = localStorage.getItem(CACHE_KEYS.TABLES);
                if (cachedTables) tables = JSON.parse(cachedTables);

                const cachedSettings = localStorage.getItem(CACHE_KEYS.TABLE_SETTINGS);
                if (cachedSettings) tableSettings = JSON.parse(cachedSettings);

                const cachedPageState = localStorage.getItem(CACHE_KEYS.PAGE_STATE);
                if (cachedPageState) {
                    const pageState = JSON.parse(cachedPageState);
                    state.currentPage = pageState.currentPage || 1;
                    state.rowsPerPage = pageState.rowsPerPage || 20;
                }

                const cachedGlobalSearch = localStorage.getItem(CACHE_KEYS.GLOBAL_SEARCH);
                if (cachedGlobalSearch) {
                    state.globalSearch = JSON.parse(cachedGlobalSearch);
                    document.getElementById('globalSearch').value = state.globalSearch;
                }

                const cachedQueries = localStorage.getItem(CACHE_KEYS.AI_SAMPLE_QUERIES);
                if (cachedQueries) suggestedQueries = JSON.parse(cachedQueries);

                return true;
            } catch (error) { return false; }
        }

        function clearCache() {
            Object.values(CACHE_KEYS).forEach(key => localStorage.removeItem(key));
            clearIDB();
        }

        // --- 4. Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded fired');
            console.log('isVSCodeWebview:', isVSCodeWebview);
            console.log('window.initialTableData:', window.initialTableData);
            
            try {
                // Check if running in VS Code webview with initial data
                if (isVSCodeWebview) {
                    // Use data provided by VS Code extension
                    initTheme();
                    if (window.initialTableData && window.initialTableData.length > 0) {
                        console.log('Loading initial data from VS Code');
                        loadInitialData();
                    } else {
                        console.log('No initial data yet, waiting...');
                        // Wait a bit for the data to be injected
                        setTimeout(() => {
                            if (window.initialTableData && window.initialTableData.length > 0) {
                                loadInitialData();
                            }
                        }, 200);
                    }
                } else {
                    // Standalone mode - use SQL.js
                    const config = { locateFile: filename => `https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/${filename}` };
                    SQL = await initSqlJs(config);
                    initTheme();
                    const restored = loadFromCache();
                    if (restored && currentDbFile) tryRestoreFromCache();
                }
            } catch (e) { console.error("Failed to load SQL.js", e); }
        });

        function loadInitialData() {
            try {
                console.log('loadInitialData called');
                console.log('initialTableData:', window.initialTableData);
                console.log('availableDatabases:', window.availableDatabases);
                
                // Load data from VS Code extension
                allData = window.initialTableData || [];
                const tableName = window.initialTableName || 'Table';
                currentTableName = tableName;
                const totalRows = window.initialTotalRows || 0;
                
                console.log('Processing data, rows:', allData.length);
                
                if (allData.length > 0) {
                    columns = Object.keys(allData[0]);
                    visibleColumns = [...columns];
                    
                    // Hide file upload controls in webview mode
                    const uploadBtn = document.getElementById('dbFileInput')?.parentElement;
                    if (uploadBtn) {
                        uploadBtn.classList.add('hidden');
                    }
                    
                    // Update DB info
                    const dbNameEl = document.getElementById('dbName');
                    const dbMetaEl = document.getElementById('dbMeta');
                    const emptyStateEl = document.getElementById('emptyState');
                    
                    if (dbNameEl) dbNameEl.textContent = tableName;
                    if (dbMetaEl) dbMetaEl.textContent = `${totalRows} total records`;
                    if (emptyStateEl) emptyStateEl.classList.add('hidden');
                    
                    console.log('Empty state hidden, showing table');
                    
                    // Setup database and table selectors if multiple databases available
                    if (availableDatabases && availableDatabases.length > 0) {
                        console.log('Setting up database selector with', availableDatabases.length, 'databases');
                        setupDatabaseSelector();
                        setupTableSelector();
                    } else {
                        // Hide table selector in single-table view
                        document.getElementById('tableSelectorContainer')?.classList.add('hidden');
                    }
                    
                    // Process and render data
                    analyzeColumns();
                    processData();
                    initTable();
                    populateSampleQueries();
                    
                    console.log('Data loaded successfully');
                } else {
                    console.warn('No data to display');
                }
            } catch (e) {
                console.error('Failed to load initial data:', e);
            }
        }

        function setupDatabaseSelector() {
            const container = document.getElementById('databaseSelectorContainer');
            const select = document.getElementById('databaseSelect');
            
            if (!container || !select || availableDatabases.length === 0) return;
            
            // Populate database selector
            select.innerHTML = availableDatabases.map(db => 
                `<option value="${db.name}">${db.name} (${db.type})</option>`
            ).join('');
            
            // Find and select current database
            const currentDb = availableDatabases.find(db => 
                db.tables.includes(currentTableName)
            );
            if (currentDb) {
                select.value = currentDb.name;
                currentDbName = currentDb.name;
            }
            
            container.classList.remove('hidden');
            document.getElementById('dbInfoContainer')?.classList.add('hidden');
        }

        function setupTableSelector() {
            const container = document.getElementById('tableSelectorContainer');
            if (!container || !currentDbName) return;
            
            const currentDb = availableDatabases.find(db => db.name === currentDbName);
            if (!currentDb) return;
            
            tables = currentDb.tables;
            
            const select = document.getElementById('tableSelect');
            if (select) {
                // Display tables with counts if available
                select.innerHTML = tables.map(t => {
                    const tableName = typeof t === 'string' ? t : t.name;
                    const count = typeof t === 'object' && t.count !== undefined ? ` (${t.count})` : '';
                    return `<option value="${tableName}" ${tableName === currentTableName ? 'selected' : ''}>${tableName}${count}</option>`;
                }).join('');
                
                container.classList.remove('hidden');
            }
        }

        function switchSelectedDatabase(dbName) {
            currentDbName = dbName;
            const db = availableDatabases.find(d => d.name === dbName);
            if (db && db.tables.length > 0) {
                // Request data for first table of selected database
                if (vscode) {
                    vscode.postMessage({
                        command: 'loadTable',
                        database: dbName,
                        table: db.tables[0]
                    });
                }
                setupTableSelector();
            }
        }

        function loadTable(tableName) {
            currentTableName = tableName;
            if (isVSCodeWebview && vscode) {
                // Request table data from VS Code extension
                vscode.postMessage({
                    command: 'loadTable',
                    database: currentDbName,
                    table: tableName
                });
            } else {
                // Standalone mode - original implementation
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.classList.remove('hidden');

                setTimeout(() => {
                    try {
                        const res = db.exec(`SELECT * FROM "${tableName}" LIMIT 5000`);
                        if (res.length > 0) {
                            columns = res[0].columns;
                            allData = res[0].values.map(row => {
                                let obj = {};
                                columns.forEach((c, i) => obj[c] = row[i]);
                                return obj;
                            });
                        } else {
                            const colRes = db.exec(`PRAGMA table_info("${tableName}")`);
                            columns = colRes[0].values.map(r => r[1]);
                            allData = [];
                        }
                        restoreTableState(tableName);
                        localStorage.setItem(CACHE_KEYS.CURRENT_TABLE, JSON.stringify(tableName));
                        saveToCache();
                        populateSampleQueries();
                    } catch (e) { alert("Error reading table: " + e.message); }
                    finally { loadingOverlay.classList.add('hidden'); }
                }, 50);
            }
        }

        async function tryRestoreFromCache() {
            if (!currentDbFile || !SQL) return;
            const loadingOverlay = document.getElementById('loadingOverlay');
            try {
                loadingOverlay.classList.remove('hidden');
                const savedUint8 = await getFileFromIDB();
                if (savedUint8) {
                    db = new SQL.Database(savedUint8);
                    if (tables.length > 0) {
                        populateTableSelector(tables);
                        document.getElementById('dbName').textContent = currentDbFile.name;
                        document.getElementById('dbMeta').textContent = `${(currentDbFile.size / 1024 / 1024).toFixed(2)} MB • SQLite (Restored)`;
                        document.getElementById('emptyState').classList.add('hidden');

                        const cachedCurrentTable = localStorage.getItem(CACHE_KEYS.CURRENT_TABLE);
                        const tableToLoad = (cachedCurrentTable && tables.includes(JSON.parse(cachedCurrentTable)))
                            ? JSON.parse(cachedCurrentTable) : tables[0];

                        if (tableToLoad) {
                            document.getElementById('tableSelect').value = tableToLoad;
                            loadTable(tableToLoad);
                        }
                        if (suggestedQueries.length > 0) populateSampleQueries();
                        generateDbAnalysis(); // Refresh analysis in background
                    }
                }
            } catch (e) { console.error("Restore failed", e); }
            finally { loadingOverlay.classList.add('hidden'); }
        }



        // --- 5. File Handling ---
        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');
            let processed = 0;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function () {
                    try {
                        const uints = new Uint8Array(reader.result);
                        databases[file.name] = { data: uints, size: file.size };

                        // Always switch to the newly uploaded file
                        switchDatabase(file.name);

                        if (++processed === files.length) {
                            loadingOverlay.classList.add('hidden');
                        }
                    } catch (e) {
                        alert("Load Error: " + e.message);
                        loadingOverlay.classList.add('hidden');
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function switchDatabase(dbName) {
            if (dbName === '__add_new__') {
                document.getElementById('dbFileInput').click();
                updateDbSelector(); // Reset selector
                return;
            }

            if (!databases[dbName]) return;
            currentDbName = dbName;

            try {
                // Init SQL.js with new data
                db = new SQL.Database(databases[dbName].data);

                // Update UI
                updateDbSelector();
                document.getElementById('emptyState').classList.add('hidden');

                // Load tables
                const res = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
                if (res.length > 0 && res[0].values.length > 0) {
                    tables = res[0].values.map(v => v[0]);
                    populateTableSelector(tables);
                    loadTable(tables[0]);
                } else {
                    tables = [];
                    populateTableSelector([]);
                    // Handle empty DB case
                }

                suggestedQueries = [];
                generateDbAnalysis();
                // saveToCache(); // TODO: Update cache logic for multi-db if needed
            } catch (e) { console.error(e); alert("Failed to switch DB: " + e.message); }
        }

        function updateDbSelector() {
            const container = document.getElementById('dbInfoContainer');
            if (Object.keys(databases).length > 0) {
                // Always show Selector to allow adding new DBs easily
                container.innerHTML = `
                    <div class="relative group">
                        <select onchange="switchDatabase(this.value)" class="appearance-none bg-transparent font-semibold text-lg text-gray-800 dark:text-zinc-100 pr-8 py-1 focus:outline-none cursor-pointer">
                            ${Object.keys(databases).map(d => `<option value="${d}" ${d === currentDbName ? 'selected' : ''}>${d}</option>`).join('')}
                            <hr>
                            <option value="__add_new__" class="text-blue-600 dark:text-blue-400 font-medium">+ Add Database...</option>
                        </select>
                         <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center text-gray-400 dark:text-zinc-500">
                            <span class="material-symbols-outlined">expand_more</span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-zinc-500" id="dbMeta">${(databases[currentDbName].size / 1024 / 1024).toFixed(2)} MB • SQLite</p>
                `;
            } else {
                // Should technically not happen if we are here, but valid for empty state
                container.innerHTML = `
                    <h1 class="text-lg font-semibold text-gray-800 leading-tight dark:text-zinc-100 flex items-center gap-2" id="dbName">No Database</h1>
                    <p class="text-xs text-gray-500 dark:text-zinc-500" id="dbMeta">Load a .sqlite file to begin</p>
                `;
            }
        }

        function populateTableSelector(tableList) {
            const select = document.getElementById('tableSelect');
            const options = tableList.map(t => {
                let count = '?';
                try {
                    const res = db.exec(`SELECT COUNT(*) as c FROM "${t}"`);
                    if (res.length > 0) count = res[0].values[0][0];
                } catch (e) { }
                return `<option value="${t}">${t} (${count})</option>`;
            });
            select.innerHTML = options.join('');
            document.getElementById('tableSelectorContainer').classList.remove('hidden');
        }

        function restoreTableState(tableName) {
            const settings = tableSettings[tableName];
            if (settings) {
                visibleColumns = settings.visibleColumns ? settings.visibleColumns.filter(c => columns.includes(c)) : [...columns];
                if (visibleColumns.length === 0) visibleColumns = [...columns];
                columnStats = settings.columnStats || {};
                state.columnFilters = settings.filters || {};
                sortConfig = settings.sortConfig || [];
            } else {
                visibleColumns = [...columns];
                columnStats = {};
                state.columnFilters = {};
                sortConfig = [];
            }
            processData();
        }
        // --- 6. AI Features (Analysis & Query Generation) ---
        async function generateDbAnalysis() {
            if (!tables.length) return;
            const hasQueries = suggestedQueries.length > 0;
            const allTablesConfigured = tables.every(t => tableSettings[t] && tableSettings[t].visibleColumns);
            if (hasQueries && allTablesConfigured) return;

            const select = document.getElementById('sampleQueries');
            select.innerHTML = '<option>✨ Analyzing Database...</option>';
            select.disabled = true;

            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-3 rounded shadow-lg z-50 flex items-center animate-pulse';
            toast.innerHTML = '<span class="material-symbols-outlined mr-2 animate-spin">auto_awesome</span> AI is analyzing your database...';
            document.body.appendChild(toast);

            try {
                let ollamaUrl = localStorage.getItem('ollama_url') || 'http://localhost:11434';
                const currentTable = document.getElementById('tableSelect')?.value;

                for (const tableName of tables) {
                    toast.innerHTML = `<span class="material-symbols-outlined mr-2 animate-spin">auto_awesome</span> Analyzing ${tableName}...`;
                    let schemaContext = '';
                    const res = db.exec(`PRAGMA table_info("${tableName}")`);
                    if (res.length > 0 && res[0].values) {
                        const cols = res[0].values.map(r => r[1]).join(', ');
                        schemaContext = `Table: ${tableName} (Cols: ${cols})`;
                    }

                    const prompt = `Analyze this table: ${schemaContext}. Return JSON with "queries" (5 SQL objects with label, sql, table) and "columns" (5-7 important col names). Only return raw JSON.`;

                    try {
                        const response = await fetch(`${ollamaUrl}/api/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: 'gpt-oss:20b',
                                prompt: prompt,
                                stream: false,
                                options: { temperature: 0.1 }
                            })
                        });
                        const data = await response.json();
                        let jsonStr = data.response.replace(/```json/g, '').replace(/```/g, '').trim();
                        const result = JSON.parse(jsonStr);

                        if (result.queries) {
                            suggestedQueries = [...suggestedQueries, ...result.queries.map(q => ({ ...q, table: tableName }))];
                            populateSampleQueries();
                        }
                        if (result.columns) {
                            if (!tableSettings[tableName]) tableSettings[tableName] = {};
                            if (!tableSettings[tableName].visibleColumns) {
                                tableSettings[tableName].visibleColumns = result.columns;
                                if (tableName === currentTable) restoreTableState(tableName);
                            }
                        }
                        saveToCache();
                    } catch (err) { console.warn(err); }
                }
                toast.innerHTML = 'Analysis Complete!';
                setTimeout(() => toast.remove(), 2000);
            } catch (e) { if (toast) toast.remove(); }
            finally { select.disabled = false; populateSampleQueries(); }
        }

        async function generateAIQuery(userPrompt) {
            let ollamaUrl = localStorage.getItem('ollama_url') || 'http://localhost:11434';
            let tableSchema = '';
            const currentTable = document.getElementById('tableSelect')?.value;
            tables.forEach(t => {
                const res = db.exec(`PRAGMA table_info("${t}")`);
                if (res.length > 0) tableSchema += `Table: ${t}\nColumns: ${res[0].values.map(r => r[1]).join(', ')}\n\n`;
            });

            const response = await fetch(`${ollamaUrl}/api/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'gpt-oss:20b',
                    prompt: `Expert SQL converter. Use schema:\n${tableSchema}\nUser: ${userPrompt}\nReturn ONLY SQL for "${currentTable}". No markdown.`,
                    stream: false
                })
            });
            const data = await response.json();
            return data.response?.trim().replace(/```sql/g, '').replace(/```/g, '');
        }

        function populateSampleQueries() {
            const select = document.getElementById('sampleQueries');
            const currentTable = currentTableName || document.getElementById('tableSelect')?.value;
            if (!currentTable) return;
            let defaults = [
                { label: "First 10 Rows", sql: `SELECT * FROM "${currentTable}" LIMIT 10` },
                { label: "Record Count", sql: `SELECT COUNT(*) FROM "${currentTable}"` },
                { label: "Random 10 Records", sql: `SELECT * FROM "${currentTable}" ORDER BY RANDOM() LIMIT 10` }
            ];
            const filtered = suggestedQueries.filter(q => q.table === currentTable);
            select.innerHTML = '<option value="">-- Sample Queries --</option>' +
                [...defaults, ...filtered].map(q => `<option value="${q.sql.replace(/"/g, '&quot;')}">${q.label}</option>`).join('');
        }

        function loadSampleQuery(val) {
            if (!val) return;
            document.getElementById('queryInput').value = val;
            setQueryMode('sql');
        }

        async function executeCustomQuery() {
            const sql = document.getElementById('queryInput').value;
            if (!sql.trim()) return;
            const status = document.getElementById('queryStatus');
            status.classList.remove('hidden');

            const isAiMode = document.getElementById('modeAi').classList.contains('bg-white');
            if (isAiMode) {
                if (isVSCodeWebview && vscode) {
                    // Send AI query request to VS Code extension with current table context
                    status.innerHTML = '✨ Generating SQL...';
                    vscode.postMessage({
                        command: 'generateAIQuery',
                        prompt: sql,
                        tableName: currentTableName,
                        database: currentDbName
                    });
                } else {
                    status.innerHTML = '✨ Generating SQL...';
                    try {
                        const finalSql = await generateAIQuery(sql);
                        document.getElementById('queryInput').value = finalSql;
                        setQueryMode('sql');
                        status.innerHTML = '✓ SQL generated. Click Run to execute.';
                    } catch (e) { status.innerHTML = "AI Error: " + e.message; }
                }
                return;
            }

            status.innerHTML = 'Executing...';
            
            if (isVSCodeWebview && vscode) {
                // Send query to VS Code extension for execution
                vscode.postMessage({
                    command: 'executeQuery',
                    query: sql
                });
            } else {
                // Standalone mode - execute with SQL.js
                setTimeout(() => {
                    try {
                        const res = db.exec(sql);
                        if (res.length === 0) { status.innerHTML = "Success. No results."; return; }
                        columns = res[0].columns;
                        allData = res[0].values.map(row => {
                            let obj = {}; columns.forEach((c, i) => obj[c] = row[i]); return obj;
                        });
                        filteredData = [...allData];
                        visibleColumns = [...columns];
                        analyzeColumns();
                        initTable();
                        updateTotalCount();
                        renderPagination();
                        status.innerHTML = `Success. ${allData.length} rows returned.`;
                    } catch (e) { status.innerHTML = "Error: " + e.message; }
                }, 100);
            }
        }

        // --- 7. Rendering Logic ---
        function analyzeColumns() {
            columnStats = {};
            const palette = [
                { bg: 'bg-blue-100', text: 'text-blue-800', darkBg: 'dark:bg-blue-900/40', darkText: 'dark:text-blue-200' },
                { bg: 'bg-green-100', text: 'text-green-800', darkBg: 'dark:bg-green-900/40', darkText: 'dark:text-green-200' },
                { bg: 'bg-purple-100', text: 'text-purple-800', darkBg: 'dark:bg-purple-900/40', darkText: 'dark:text-purple-200' },
                { bg: 'bg-yellow-100', text: 'text-yellow-800', darkBg: 'dark:bg-yellow-900/40', darkText: 'dark:text-yellow-200' },
                { bg: 'bg-pink-100', text: 'text-pink-800', darkBg: 'dark:bg-pink-900/40', darkText: 'dark:text-pink-200' },
                { bg: 'bg-gray-100', text: 'text-gray-800', darkBg: 'dark:bg-zinc-800', darkText: 'dark:text-zinc-300' }
            ];

            if (allData.length === 0) return;
            columns.forEach(col => {
                const sampleVal = allData[0][col];
                const type = typeof sampleVal;
                if (type === 'string' && !col.toLowerCase().includes('id')) {
                    const uniqueValues = new Set(allData.slice(0, 1000).map(d => d[col]));
                    if (uniqueValues.size < 15 && uniqueValues.size > 1) {
                        const valueColorMap = {};
                        let colorIdx = 0;
                        Array.from(uniqueValues).sort().forEach(val => {
                            valueColorMap[val] = palette[colorIdx % palette.length];
                            colorIdx++;
                        });
                        columnStats[col] = { isEnum: true, options: Array.from(uniqueValues).sort(), colorMap: valueColorMap };
                        return;
                    }
                }
                columnStats[col] = { isEnum: false };
            });
        }

        function initTable() {
            renderHeader();
            renderBody();
        }

        function renderHeader() {
            const tr = document.getElementById('tableHeaderRow');
            tr.innerHTML = visibleColumns.map((col) => {
                const sortIndex = sortConfig.findIndex(s => s.col === col);
                const isSorted = sortIndex !== -1;
                const sortDir = isSorted ? sortConfig[sortIndex].dir : null;
                const isFiltered = state.columnFilters[col];

                return `
                <th draggable="true"
                    class="px-6 py-3 border-b border-gray-200 dark:border-zinc-800 bg-gray-50 dark:bg-zinc-900 group hover:bg-gray-100 dark:hover:bg-zinc-800 transition-colors select-none cursor-pointer relative"
                    onclick="handleSort(event, '${col}')"
                    ondragstart="handleDragStart(event, '${col}')" ondragover="handleDragOver(event, '${col}')" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, '${col}')">
                    <div class="flex items-center justify-between">
                        <span class="whitespace-nowrap flex items-center gap-1 ${isSorted ? 'text-blue-600 dark:text-blue-400 font-bold' : 'text-gray-600 dark:text-zinc-400'}">
                            <span class="material-symbols-outlined text-gray-300 dark:text-zinc-700 text-sm cursor-grab active:cursor-grabbing mr-1 opacity-0 group-hover:opacity-100 transition-opacity">drag_indicator</span>
                            ${formatColumnName(col)}
                            ${isSorted ? `<span class="material-symbols-outlined text-sm font-bold">${sortDir === 'asc' ? 'arrow_upward' : 'arrow_downward'}</span>` : ''}
                            ${(isSorted && sortConfig.length > 1) ? `<span class="sort-badge">${sortIndex + 1}</span>` : ''}
                        </span>
                        <div class="flex items-center opacity-0 group-hover:opacity-100 ${isFiltered ? 'opacity-100' : ''} transition-opacity">
                            <button onclick="openFilter(event, '${col}')"
                                class="p-1 rounded hover:bg-gray-200 dark:hover:bg-zinc-700 ${isFiltered ? 'text-blue-600 bg-blue-50 dark:bg-blue-900/30 dark:text-blue-300' : 'text-gray-400 dark:text-zinc-500'}">
                                <span class="material-symbols-outlined text-base">filter_alt</span>
                            </button>
                        </div>
                    </div>
                </th>`;
            }).join('');
        }

        function renderBody() {
            const tbody = document.getElementById('tableBody');
            if (filteredData.length === 0) {
                tbody.innerHTML = db ? `<tr><td colspan="${visibleColumns.length}" class="px-6 py-12 text-center text-gray-400 dark:text-zinc-500 italic">No records found matching your filters.</td></tr>` : '';
                return;
            }

            const start = (state.currentPage - 1) * state.rowsPerPage;
            const end = start + state.rowsPerPage;
            const pageData = filteredData.slice(start, end);

            tbody.innerHTML = pageData.map((row) => `
                <tr class="hover:bg-blue-50/50 dark:hover:bg-zinc-800/50 transition-colors group border-b border-gray-100 dark:border-zinc-800 last:border-0">
                    ${visibleColumns.map(col => {
                const val = row[col];
                let content = val;
                let cls = 'text-gray-700 dark:text-zinc-300';
                const stats = columnStats[col];

                if (val === null || val === undefined) {
                    content = '<span class="text-gray-300 dark:text-zinc-700 italic">null</span>';
                } else if (stats && stats.isEnum) {
                    const color = stats.colorMap[val] || { bg: 'bg-gray-100', text: 'text-gray-800', darkBg: 'dark:bg-zinc-800', darkText: 'dark:text-zinc-300' };
                    content = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${color.bg} ${color.text} ${color.darkBg} ${color.darkText}">${val}</span>`;
                } else if (typeof val === 'boolean' || (typeof val === 'number' && (val === 0 || val === 1) && col.toLowerCase().startsWith('is_'))) {
                    const boolVal = (val === true || val === 1);
                    content = boolVal ?
                        `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300">TRUE</span>` :
                        `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300">FALSE</span>`;
                } else if (typeof val === 'number') {
                    cls = 'font-mono text-gray-600 dark:text-zinc-400';
                }
                return `<td class="px-6 py-3 whitespace-nowrap ${cls}">${content}</td>`;
            }).join('')}
                </tr>
            `).join('');
        }

        // --- 8. Data Operations (Filter/Sort/Paginate) ---
        function handleSort(event, col) {
            const isShift = event.shiftKey;
            const existingIndex = sortConfig.findIndex(s => s.col === col);
            if (isShift) {
                if (existingIndex !== -1) {
                    if (sortConfig[existingIndex].dir === 'asc') sortConfig[existingIndex].dir = 'desc';
                    else sortConfig.splice(existingIndex, 1);
                } else sortConfig.push({ col: col, dir: 'asc' });
            } else {
                if (existingIndex !== -1 && sortConfig.length === 1) {
                    if (sortConfig[0].dir === 'asc') sortConfig[0].dir = 'desc';
                    else sortConfig = [];
                } else sortConfig = [{ col: col, dir: 'asc' }];
            }
            processData();
        }

        function processData() {
            let temp = allData.filter(row => {
                if (state.globalSearch) {
                    const term = state.globalSearch.toLowerCase();
                    if (!Object.values(row).some(val => String(val).toLowerCase().includes(term))) return false;
                }
                for (const [col, filter] of Object.entries(state.columnFilters)) {
                    let val = row[col];
                    const { value, op, value2 } = filter;
                    if (val === null || val === undefined) return false;
                    const sVal = String(val).toLowerCase();
                    const sFVal = String(value).toLowerCase();

                    if (op === 'contains' && !sVal.includes(sFVal)) return false;
                    if (op === 'not_contains' && sVal.includes(sFVal)) return false;
                    if (op === '=' && sVal != sFVal) return false;
                    if (op === '!=' && sVal == sFVal) return false;
                    if (op === '>') { if (val <= value) return false; }
                    if (op === '<') { if (val >= value) return false; }
                    if (op === 'range') { if (val < value || val > value2) return false; }
                }
                return true;
            });

            if (sortConfig.length > 0) {
                temp.sort((a, b) => {
                    for (const sort of sortConfig) {
                        const valA = a[sort.col];
                        const valB = b[sort.col];
                        if (valA < valB) return sort.dir === 'asc' ? -1 : 1;
                        if (valA > valB) return sort.dir === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            }
            filteredData = temp;
            state.currentPage = 1;
            updateUI();
            saveToCache();
        }

        function updateUI() {
            renderHeader(); renderBody(); renderPagination(); updateTotalCount();
            const badge = document.getElementById('filterBadge');
            if (badge) Object.keys(state.columnFilters).length > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
        }

        function updateTotalCount() { document.getElementById('totalRecords').textContent = `${filteredData.length} Records`; }
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / state.rowsPerPage) || 1;
            document.getElementById('pageInfo').textContent = `Page ${state.currentPage} of ${totalPages}`;
            document.getElementById('btnPrev').disabled = state.currentPage === 1;
            document.getElementById('btnNext').disabled = state.currentPage === totalPages;
        }

        function nextPage() { if (state.currentPage < Math.ceil(filteredData.length / state.rowsPerPage)) { state.currentPage++; updateUI(); saveToCache(); } }
        function prevPage() { if (state.currentPage > 1) { state.currentPage--; updateUI(); saveToCache(); } }
        function changeRowsPerPage(val) { state.rowsPerPage = parseInt(val); state.currentPage = 1; updateUI(); saveToCache(); }
        function formatColumnName(col) { return col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); }

        // --- 9. Popovers & UI State ---
        let currentFilterCol = null;
        function openFilter(event, col) {
            event.stopPropagation();
            currentFilterCol = col;
            const btn = event.currentTarget;
            const rect = btn.getBoundingClientRect();
            const popover = document.getElementById('filterPopover');
            let left = rect.left;
            if (left + 320 > window.innerWidth) left = window.innerWidth - 330;
            popover.style.top = (rect.bottom + 5) + 'px';
            popover.style.left = left + 'px';

            document.getElementById('filterTitle').textContent = `Filter ${formatColumnName(col)}`;
            const current = state.columnFilters[col] || { op: 'contains', value: '' };

            const html = `
                <select id="filterOp" class="w-full mb-3 border border-gray-300 rounded-lg p-2 text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200">
                    <option value="contains" ${current.op === 'contains' ? 'selected' : ''}>Contains</option>
                    <option value="not_contains" ${current.op === 'not_contains' ? 'selected' : ''}>Does Not Contain</option>
                    <option value="=" ${current.op === '=' ? 'selected' : ''}>Equals</option>
                    <option value="!=" ${current.op === '!=' ? 'selected' : ''}>Not Equals</option>
                    <option value=">" ${current.op === '>' ? 'selected' : ''}>Greater Than</option>
                    <option value="<" ${current.op === '<' ? 'selected' : ''}>Less Than</option>
                </select>
                <input type="text" id="filterVal" value="${current.value}" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 dark:bg-zinc-800 dark:border-zinc-700 dark:text-zinc-200" placeholder="Value..." autofocus>
            `;
            document.getElementById('filterContent').innerHTML = html;
            popover.classList.remove('hidden');
            setTimeout(() => document.getElementById('filterVal').focus(), 50);
        }

        function applyCurrentFilter() {
            const op = document.getElementById('filterOp').value;
            const val = document.getElementById('filterVal').value;
            if (val === '') delete state.columnFilters[currentFilterCol];
            else state.columnFilters[currentFilterCol] = { op, value: val };
            closeFilterPopover();
            processData();
        }

        function clearCurrentFilter() { delete state.columnFilters[currentFilterCol]; closeFilterPopover(); processData(); }
        function closeFilterPopover() { document.getElementById('filterPopover').classList.add('hidden'); }
        function clearAllFilters() { state.columnFilters = {}; document.getElementById('globalSearch').value = ''; state.globalSearch = ''; processData(); }

        function toggleColumnManager(e) {
            e.stopPropagation();
            const el = document.getElementById('columnManager');
            el.classList.toggle('hidden');
            if (!el.classList.contains('hidden')) {
                document.getElementById('columnList').innerHTML = columns.map(col => `
                    <label class="flex items-center space-x-2 p-2 hover:bg-gray-100 dark:hover:bg-zinc-800 rounded-lg cursor-pointer">
                        <input type="checkbox" onchange="toggleColumn('${col}')" ${visibleColumns.includes(col) ? 'checked' : ''} class="rounded text-blue-600 border-gray-300 dark:bg-zinc-700 dark:border-zinc-600">
                        <span class="text-gray-700 dark:text-zinc-300 text-sm font-medium">${formatColumnName(col)}</span>
                    </label>
                `).join('');
            }
        }

        function toggleColumn(col) {
            if (visibleColumns.includes(col)) visibleColumns = visibleColumns.filter(c => c !== col);
            else { visibleColumns.push(col); visibleColumns.sort((a, b) => columns.indexOf(a) - columns.indexOf(b)); }
            initTable(); saveToCache();
        }

        function resetView() { visibleColumns = [...columns]; clearAllFilters(); sortConfig = []; analyzeColumns(); initTable(); saveToCache(); }

        function handleDragStart(e, col) { draggedColumn = col; e.target.closest('th').classList.add('dragging'); }
        function handleDragOver(e, col) {
            e.preventDefault(); if (draggedColumn === col) return;
            const th = e.currentTarget; const rect = th.getBoundingClientRect();
            th.classList.remove('drag-over-left', 'drag-over-right');
            if (e.clientX < rect.left + rect.width / 2) th.classList.add('drag-over-left'); else th.classList.add('drag-over-right');
        }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over-left', 'drag-over-right'); }
        function handleDrop(e, targetCol) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over-left', 'drag-over-right');
            document.querySelectorAll('th').forEach(th => th.classList.remove('dragging'));
            if (draggedColumn && draggedColumn !== targetCol) {
                const oldIdx = visibleColumns.indexOf(draggedColumn);
                visibleColumns.splice(oldIdx, 1);
                const rect = e.currentTarget.getBoundingClientRect();
                const newIdx = (e.clientX < rect.left + rect.width / 2) ? visibleColumns.indexOf(targetCol) : visibleColumns.indexOf(targetCol) + 1;
                visibleColumns.splice(newIdx, 0, draggedColumn);
                initTable(); saveToCache();
            }
        }

        function toggleQueryPanel() { document.getElementById('queryPanel').classList.toggle('hidden'); }
        function setQueryMode(mode) {
            const sqlBtn = document.getElementById('modeSql');
            const aiBtn = document.getElementById('modeAi');
            const input = document.getElementById('queryInput');
            const runBtn = document.getElementById('runQueryBtn');

            if (mode === 'sql') {
                sqlBtn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                sqlBtn.classList.remove('text-gray-500', 'dark:text-zinc-400');
                aiBtn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                aiBtn.classList.add('text-gray-500', 'dark:text-zinc-400');
                input.placeholder = "SELECT * FROM...";
                document.getElementById('sampleQueriesContainer').classList.remove('hidden');
                runBtn.innerHTML = `<span class="material-symbols-outlined text-sm">play_arrow</span> Run`;
                runBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                runBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                aiBtn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                aiBtn.classList.remove('text-gray-500', 'dark:text-zinc-400');
                sqlBtn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                sqlBtn.classList.add('text-gray-500', 'dark:text-zinc-400');
                input.placeholder = "Ask AI in plain English...";
                document.getElementById('sampleQueriesContainer').classList.add('hidden');
                runBtn.innerHTML = `<span class="material-symbols-outlined text-sm">auto_fix_high</span> Generate`;
                runBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                runBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            }
        }

        function clearQuery() { document.getElementById('queryInput').value = ''; }
        function exportData() {
            if (filteredData.length === 0) return alert("No data");
            const header = visibleColumns.join(",");
            const rows = filteredData.map(row => visibleColumns.map(col => `"${String(row[col] || '').replace(/"/g, '""')}"`).join(",")).join("\n");
            const csvData = header + "\n" + rows;
            
            if (isVSCodeWebview && vscode) {
                // Send export request to VS Code extension
                vscode.postMessage({
                    command: 'export',
                    data: csvData,
                    filename: `${window.initialTableName || 'export'}.csv`
                });
            } else {
                // Standalone mode - download directly
                const blob = new Blob([csvData], { type: "text/csv" });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a"); 
                a.href = url; 
                a.download = "export.csv"; 
                a.click();
            }
        }

        // --- VS Code Webview Message Handler ---
        if (isVSCodeWebview) {
            window.addEventListener('message', event => {
                const message = event.data;
                const status = document.getElementById('queryStatus');
                
                switch (message.command) {
                    case 'queryResult':
                        if (message.data && message.data.length > 0) {
                            allData = message.data;
                            columns = Object.keys(message.data[0]);
                            visibleColumns = [...columns];
                            analyzeColumns();
                            processData();
                            initTable();
                            if (status) {
                                status.classList.remove('hidden');
                                status.innerHTML = `✓ Query returned ${message.data.length} rows`;
                                setTimeout(() => status.classList.add('hidden'), 3000);
                            }
                        } else {
                            if (status) {
                                status.classList.remove('hidden');
                                status.innerHTML = '✓ Query executed successfully (no results)';
                                setTimeout(() => status.classList.add('hidden'), 3000);
                            }
                        }
                        break;

                    case 'queryError':
                        if (status) {
                            status.classList.remove('hidden');
                            status.innerHTML = '✗ Error: ' + message.error;
                        }
                        break;

                    case 'aiQueryResult':
                        document.getElementById('queryInput').value = message.sqlQuery;
                        setQueryMode('sql');
                        if (status) {
                            status.classList.remove('hidden');
                            status.innerHTML = '✓ SQL generated. Click Run to execute.';
                        }
                        break;
                        
                    case 'aiQueryError':
                        if (status) {
                            status.classList.remove('hidden');
                            status.innerHTML = '✗ AI Error: ' + message.error;
                        }
                        break;
                        
                    case 'pageData':
                        // Handle pagination data from extension
                        allData = message.data || [];
                        if (allData.length > 0) {
                            columns = Object.keys(allData[0]);
                            visibleColumns = [...columns];
                            analyzeColumns();
                            processData();
                            initTable();
                        }
                        break;
                        
                    case 'tableData':
                        // Handle table data load from extension
                        allData = message.data || [];
                        currentTableName = message.table;
                        if (allData.length > 0) {
                            columns = Object.keys(allData[0]);
                            visibleColumns = [...columns];
                            
                            // Update UI
                            document.getElementById('dbName').textContent = message.table;
                            document.getElementById('dbMeta').textContent = `${message.totalRows || allData.length} total records`;
                            
                            // Update table selector
                            const tableSelect = document.getElementById('tableSelect');
                            if (tableSelect) {
                                tableSelect.value = message.table;
                            }
                            
                            analyzeColumns();
                            processData();
                            initTable();
                            populateSampleQueries();
                        }
                        break;
                        
                    case 'updateDatabases':
                        // Update available databases list
                        availableDatabases = message.databases || [];
                        setupDatabaseSelector();
                        if (message.currentDatabase) {
                            currentDbName = message.currentDatabase;
                            const dbSelect = document.getElementById('databaseSelect');
                            if (dbSelect) {
                                dbSelect.value = currentDbName;
                            }
                            setupTableSelector();
                        }
                        if (message.currentTable) {
                            currentTableName = message.currentTable;
                            const tableSelect = document.getElementById('tableSelect');
                            if (tableSelect) {
                                tableSelect.value = currentTableName;
                            }
                        }
                        break;
                        
                    case 'updateDatabasesWithCounts':
                        // Update databases with row counts
                        availableDatabases = message.databases || [];
                        setupTableSelector();
                        break;
                }
            });
        }

        document.getElementById('globalSearch').addEventListener('input', (e) => { state.globalSearch = e.target.value; processData(); });
        document.addEventListener('click', (e) => {
            if (!document.getElementById('filterPopover').classList.contains('hidden') && !e.target.closest('#filterPopover') && !e.target.closest('button[onclick*="openFilter"]')) closeFilterPopover();
            if (!document.getElementById('columnManager').classList.contains('hidden') && !e.target.closest('#columnManager') && !e.target.closest('button[onclick*="toggleColumnManager"]')) document.getElementById('columnManager').classList.add('hidden');
        });
    </script>
</body>

</html>